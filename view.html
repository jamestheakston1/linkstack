<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkStack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { min-height: 100vh; transition: background 0.5s ease; }
        .link-card { transition: transform 0.2s, background 0.2s; }
        .link-card:hover { transform: translateY(-2px); }
        .hidden { display: none !important; }
        .glass-effect { backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="flex flex-col items-center justify-start antialiased">

    <div id="loading-screen" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div>
    </div>

    <main class="w-full max-w-md px-6 pt-16 pb-20 flex flex-col items-center text-center">
        
        <div class="relative mb-6">
            <img id="user-avatar" class="w-28 h-28 rounded-full border-4 border-white/20 shadow-2xl object-cover bg-slate-800" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
            <div id="verified-badge" class="hidden absolute -right-1 bottom-1">
                <svg width="32" height="32" viewBox="0 0 512 512"><g fill="none" fill-rule="evenodd"><path d="M256 472.153L176.892 512l-41.725-81.129-86.275-16.654 11.596-91.422L0 256l60.488-66.795-11.596-91.422 86.275-16.654L176.892 0 256 39.847 335.108 0l41.725 81.129 86.275 16.654-11.596 91.422L512 256l-60.488 66.795 11.596 91.422-86.275 16.654L335.108 512z" fill="#4285f4"/><path d="M211.824 284.5L171 243.678l-36 36 40.824 40.824-.063.062 36 36 .063-.062.062.062 36-36-.062-.062L376.324 192l-36-36z" fill="#fff"/></g></svg>
            </div>
        </div>

        <h1 id="user-handle" class="text-2xl font-black mb-2 tracking-tight"></h1>
        <p id="user-bio" class="text-sm font-medium opacity-80 mb-8 max-w-xs leading-relaxed"></p>

        <div id="social-container" class="flex gap-6 mb-10 opacity-70"></div>

        <div id="links-container" class="w-full space-y-4"></div>

        <footer class="mt-20">
            <a href="/" class="flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.2em] opacity-40 hover:opacity-100 transition">
                <i data-feather="layers" class="w-3 h-3"></i>
                Create your LinkStack
            </a>
        </footer>
    </main>

    <script>
        const SUPABASE_URL = 'https://xcicvuqdoztxhidwdmlc.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_DeSw5UHzjV444ZF6eMkB0g_taV-dynR';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const themeConfig = {
            default: { bg: '#0f172a', btn: 'bg-white/10 text-white hover:bg-white/20', text: 'text-white' },
            sunset: { bg: 'linear-gradient(135deg, #fb923c, #db2777)', btn: 'bg-white text-orange-600 hover:bg-orange-50', text: 'text-white' },
            forest: { bg: '#064e3b', btn: 'bg-emerald-500 text-white hover:bg-emerald-400', text: 'text-emerald-50' },
            cotton: { bg: '#fdf2f8', btn: 'bg-pink-500 text-white hover:bg-pink-600', text: 'text-pink-900' },
            glass: { bg: 'url(https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe) center/cover fixed', btn: 'bg-white/20 glass-effect text-white hover:bg-white/30', text: 'text-white' }
        };

        async function renderView() {
            const urlParams = new URLSearchParams(window.location.search);
            const handle = urlParams.get('u');

            if (!handle) {
                window.location.href = '/';
                return;
            }

            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('handle', handle)
                .single();

            if (error || !profile) {
                document.body.innerHTML = '<div class="flex h-screen items-center justify-center font-bold">Profile not found.</div>';
                return;
            }

            const { data: links } = await supabaseClient
                .from('links')
                .select('*')
                .eq('user_id', profile.id)
                .order('created_at', { ascending: false });

            applyTheme(profile.theme_id || 'default');
            
            document.getElementById('user-handle').innerText = `@${profile.handle}`;
            document.getElementById('user-bio').innerText = profile.bio || '';
            document.getElementById('user-avatar').src = profile.avatar_url || `https://ui-avatars.com/api/?name=${profile.handle}`;
            
            if (profile.is_verified) {
                document.getElementById('verified-badge').classList.remove('hidden');
            }

            const socialCont = document.getElementById('social-container');
            const socials = [
                { id: 'ig_handle', icon: 'instagram', prefix: 'https://instagram.com/' },
                { id: 'tw_handle', icon: 'twitter', prefix: 'https://twitter.com/' },
                { id: 'li_handle', icon: 'linkedin', prefix: '' },
                { id: 'yt_handle', icon: 'youtube', prefix: '' },
                { id: 'wa_handle', icon: 'message-circle', prefix: 'https://wa.me/' }
            ];

            socials.forEach(s => {
                if (profile[s.id]) {
                    const link = profile[s.id].startsWith('http') ? profile[s.id] : s.prefix + profile[s.id];
                    socialCont.innerHTML += `<a href="${link}" target="_blank" class="hover:scale-110 transition"><i data-feather="${s.icon}"></i></a>`;
                }
            });

            const linksCont = document.getElementById('links-container');
            const theme = themeConfig[profile.theme_id || 'default'];
            
            links.forEach(l => {
                linksCont.innerHTML += `
                    <a href="${l.url}" target="_blank" class="link-card block w-full p-5 rounded-[1.25rem] font-black text-sm shadow-lg ${theme.btn}">
                        ${l.label}
                    </a>`;
            });

            document.getElementById('loading-screen').classList.add('hidden');
            feather.replace();

            trackVisit(profile.id);
        }

        function applyTheme(id) {
            const theme = themeConfig[id] || themeConfig.default;
            document.body.style.background = theme.bg;
            document.body.className = `flex flex-col items-center justify-start antialiased ${theme.text}`;
            if (theme.bg.includes('url')) {
                document.body.style.backgroundAttachment = 'fixed';
                document.body.style.backgroundSize = 'cover';
            }
        }

        async function trackVisit(profileId) {
            try {
                const geoRes = await fetch('https://ipapi.co/json/');
                const geoData = await geoRes.json();
                
                await supabaseClient.from('visits').insert({
                    profile_id: profileId,
                    country_code: geoData.country_code || 'UN'
                });
            } catch (e) {
                console.error('Analytics blocked or failed');
            }
        }

        renderView();
    </script>
</body>
</html>
